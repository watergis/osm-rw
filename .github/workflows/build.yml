name: "Build & deploy vector tiles"

on:
  push:
    branches: [ main ]
  pull_request:

env:
  REGION: africa
  AREA: kenya
  TILEMAKER_IMAGE: ghcr.io/jinigarashi/tilemaker:pr-1
  PMTILES_IMAGE: ghcr.io/protomaps/go-pmtiles:main

jobs:

  tilemaker-build:
    name: Generate vector tiles by tilemaker
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Download PBF file
      run: |
        mkdir data
        curl -L http://download.geofabrik.de/${{ env.REGION }}/${{ env.AREA }}-latest.osm.pbf -o ./data/${{ env.AREA }}.osm.pbf

    - name: pull docker image
      run: |
        docker pull ${{ env.TILEMAKER_IMAGE }}
        docker pull ${{ env.PMTILES_IMAGE }}

    - name: Build openmaptiles-compatible mbtiles files of given area
      run: docker run -v $(pwd)/data:/srv ${{ env.TILEMAKER_IMAGE }} --input=/srv/${{ env.AREA }}.osm.pbf --output=/srv/${{ env.AREA }}.mbtiles

    - name: Convert mbtiles to pmtiles
      run: |
        docker run -v $(pwd)/data:/srv ${{ env.PMTILES_IMAGE }} convert /srv/${{ env.AREA }}.mbtiles /srv/${{ env.AREA }}.pmtiles --tmpdir=/workspace

    - name: clean deploy folder
      run: |
        rm ./data/${{ env.AREA }}.osm.pbf
        rm ./data/${{ env.AREA }}.mbtiles

    - name: Publish to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        directory: data
        # Enable Wrangler v3
        wranglerVersion: '3'
